<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ID Card — Robust Download</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f7fb;padding:20px;}
  .controls{margin-bottom:12px;}
  input{padding:8px;width:220px}
  button{padding:8px 12px;margin-left:6px;cursor:pointer}
  #idCard{width:360px;background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
  .photo{width:110px;height:110px;border-radius:50%;object-fit:cover;border:2px solid #ddd;display:block;margin:8px auto}
  .info p{margin:6px 0;font-size:14px}
  #log{margin-top:12px;font-family:monospace;background:#111;color:#fff;padding:8px;border-radius:6px;max-height:160px;overflow:auto}
</style>
</head>
<body>

<h3>Test ID Card — Robust Download</h3>
<div class="controls">
  <input id="inpId" placeholder="Enter ID or roll" />
  <button id="btnGen">Generate</button>
</div>

<div id="cardWrap"></div>

<div style="margin-top:12px">
  <button id="btnDownloadPNG" disabled>Download PNG</button>
  <button id="btnDownloadPDF" disabled>Download PDF</button>
  <button id="btnDownloadQR" disabled>Download QR</button>
</div>

<pre id="log">Console log will appear here...</pre>

<script>
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1mFO4VfkTJRbWyToBP2BSobb44HVDVfPrL04R7UdflYg/export?format=csv&gid=0";

const logEl = document.getElementById('log');
function log(...args){ console.log(...args); logEl.textContent += '\\n' + args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' '); logEl.scrollTop = logEl.scrollHeight; }

let currentStudent = null;
let qrCanvas = null;

document.getElementById('btnGen').addEventListener('click', async () => {
  log('Generating card — fetching sheet...');
  const id = document.getElementById('inpId').value.trim();
  if(!id){ alert('Enter ID / roll'); return; }

  try {
    const results = await new Promise((res,rej) => Papa.parse(SHEET_CSV_URL, { download:true, header:true, skipEmptyLines:true, complete:res, error:rej }));
    const data = results.data.map(r=>{
      const out = {};
      Object.keys(r).forEach(k => { out[k.trim().toLowerCase()] = (r[k]||'').trim(); });
      return out;
    });
    const s = data.find(row =>
      (row['id no'] && row['id no'].trim()===id) ||
      (row['id'] && row['id'].trim()===id) ||
      (row['roll'] && row['roll'].trim()===id)
    );
    if(!s){ document.getElementById('cardWrap').innerHTML = '<p style="color:red">Student not found</p>'; log('Student not found for', id); return; }
    currentStudent = s;
    renderCard(s);
    log('Card rendered for', s['name'] || s['id no']);
  } catch(err){ log('Error parsing sheet:', err); alert('Error fetching sheet — see console'); }
});

function renderCard(s){
  // ensure image URLs are raw/github or drive-uc format; we won't change them here but log
  log('photo url:', s['photo'] || 'none', 'logo url:', s['logo'] || 'none');

  document.getElementById('cardWrap').innerHTML = `
    <div id="idCard" style="--watermark:url('${(s['logo']||'')}')">
      <div style="text-align:center;font-weight:700;color:#003366">${s['college name']||'College'}</div>
      <img id="studPhoto" class="photo" src="${s['photo']||''}" crossorigin="anonymous" onerror="this.dataset.err=1;this.src='https://via.placeholder.com/110'">
      <div class="info">
        <p><strong>Name:</strong> ${s['name']||''}</p>
        <p><strong>ID No:</strong> ${s['id no']||''} &nbsp; <strong>Roll:</strong> ${s['roll']||''}</p>
        <p><strong>Branch:</strong> ${s['branch']||''}</p>
      </div>
      <div style="text-align:center;margin-top:8px"><canvas id="qrCanvas" width="140" height="140"></canvas></div>
    </div>
  `;
  // generate QR
  qrCanvas = document.getElementById('qrCanvas');
  try {
    QRCode.toCanvas(qrCanvas, `ID:${s['id no']||''}\nName:${s['name']||''}`, {width:140, margin:1});
  } catch(e){ log('QR error', e); }
  // enable buttons after ensuring images loaded
  waitForImages(document.getElementById('idCard')).then(ok=>{
    log('All images loaded (ok?)', ok);
    document.getElementById('btnDownloadPNG').disabled = false;
    document.getElementById('btnDownloadPDF').disabled = false;
    document.getElementById('btnDownloadQR').disabled = false;
  }).catch(err=>{
    log('Image load error:', err);
    document.getElementById('btnDownloadPNG').disabled = false; // allow to try anyway
    document.getElementById('btnDownloadPDF').disabled = false;
    document.getElementById('btnDownloadQR').disabled = false;
  });
}

// wait until images in container are loaded (or error)
function waitForImages(container, timeout=8000){
  const imgs = Array.from(container.querySelectorAll('img'));
  if(imgs.length===0) return Promise.resolve(true);
  return Promise.race([
    Promise.all(imgs.map(img=>{
      if(img.complete) return Promise.resolve(true);
      return new Promise(res => {
        img.onload = () => res(true);
        img.onerror = () => { log('Image failed to load:', img.src); res(false); };
      });
    })),
    new Promise((_,rej)=>setTimeout(()=>rej('timeout waiting images'), timeout))
  ]);
}

// Utility: download a dataURL by converting to blob (more reliable for large files)
async function downloadDataUrl(name, dataUrl){
  try{
    const res = await fetch(dataUrl);
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url), 15000);
    log('Download triggered:', name);
  } catch(e){ log('downloadDataUrl error:', e); alert('Download failed — check console for details'); }
}

// PNG download
document.getElementById('btnDownloadPNG').addEventListener('click', async ()=>{
  if(!currentStudent){ alert('Generate card first'); return; }
  const card = document.getElementById('idCard');
  try{
    log('Capturing canvas (PNG)...');
    await waitForImages(card).catch(e=>log('waitForImages err (continuing):', e));
    const canvas = await html2canvas(card, {scale:3, useCORS:true, backgroundColor:'#fff'});
    const dataUrl = canvas.toDataURL('image/png');
    await downloadDataUrl(`${(currentStudent['id no']||'idcard')}.png`, dataUrl);
  }catch(err){ log('PNG capture error:', err); alert('PNG capture failed — see console'); }
});

// PDF download
document.getElementById('btnDownloadPDF').addEventListener('click', async ()=>{
  if(!currentStudent){ alert('Generate card first'); return; }
  const card = document.getElementById('idCard');
  try{
    log('Capturing canvas (for PDF)...');
    await waitForImages(card).catch(e=>log('waitForImages err (continuing):', e));
    const canvas = await html2canvas(card, {scale:3, useCORS:true, backgroundColor:'#fff'});
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
    // pdf.save will use blob internally; to show robustness we convert to blob and trigger download ourselves
    const pdfBlob = pdf.output('blob');
    const url = URL.createObjectURL(pdfBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${(currentStudent['id no']||'idcard')}.pdf`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url),15000);
    log('PDF download triggered');
  }catch(err){ log('PDF error:', err); alert('PDF generation failed — see console'); }
});

// QR only
document.getElementById('btnDownloadQR').addEventListener('click', async ()=>{
  if(!qrCanvas){ alert('Generate card first'); return; }
  try{
    const dataUrl = qrCanvas.toDataURL('image/png');
    await downloadDataUrl('qr.png', dataUrl);
  }catch(err){ log('QR download err', err); }
});
</script>
</body>
</html>
